---
title: Diff算法
date: 2023-04-07 21:00:00
categories: [面试题]
tags: [Vue, Diff]
---

## 1、首先什么是虚拟 DOM?

虚拟 DOM 就是一个普通的 JS 对象，用来描述真实的 DOM 结构的对象

## 2、什么事 Diff 算法？

diff 算法是用来比较虚拟节点、并返回一个 patch 对象，用来存储新旧节点不同的地方
简单来说：diff 的过程就是调用 patch 函数，比较新旧节点，边比较边给 DOM 打补丁

> 那么 diff 算法有什么特征呢？

1. 比较只会发生在同层级进行，不会跨层级比较
2. diff 比较的过程中，循环从两边向中间比较

> diff 算法的步骤

- 用 js 对象结构表示 ODM 的结构，然后用这个树结果创建一个真实的 DOM，插入到页面中
- 当状态发生变化时，重新构造一个新的对象树
- 新旧对象树进行比较（diff）,记录差异变化
- 把记录的差异应用到真实 DOM 树上（patch），完成视图的更新

> 原理分析

当数据发生变化时，set 方法会调用 Dep.notify 通知所以得订阅者 Watcher,订阅者会调用 patch 给真实的 DOM 打补丁，更新响应的视图

## Vue2 中的 Diff

> 双端 diff 算法

1. 当数据发生变化时，订阅者 Watcher 会调用 patch 给真实 DOM 打补丁
2. 通过 SameVnode(oldVode, newVode)进行判断，相同时则调用 patchVnode 方法
3. patchVnode
   - 判断文本节点，直接设置文本
   - 子节点比较
     一方不存在是，直接删除或创建
     两者都有时，执行 updateChildren 函数比较子节点
4. updateChildren
   - 设置新旧 vnode 的头尾指针
   - 新旧头尾进行比较，循环先中间靠拢（四个角向中间靠拢比较）
     根据情况调用 patchVnode 进行 patch 重复流程、调用 createElem 创建一个新的节点
     从哈希表寻找 key 一致的 vNode 节点再分情况操作

## vue3 中的 Diff

> 快速 diff 算法

Vue3 在真正的 diff 之前会执行一段“预处理”的前置操作，目的是先把科一直接排除的项直接去掉

1. 对比新旧节点头部相同指针的节点，相同则进行 diff，不同就跳转下一步
2. 新旧节点尾部指针指向的节点，相同则进行 diff，不同就跳转下一步
3. 此时剩余新旧节点可能存在乱序、一移除、新创建的情况，进行特殊处理来更新
   - 增删节点
   - diff
     首先根据新节点剩余内容，跟 key 创建一个 map 映射
     最长递增子序列 为减少 dom 的操作

> vue3 牺牲了一部分 js 性能，换来了 dom 渲染的性能
